#!/bin/bash

origDir="$PWD"
testDir="../cycleTracksTest"

if [ -d "$testDir" ]; then
    rm -rf $testDir/*
else
    mkdir -p $testDir
fi

cd $testDir

echo "cd $testDir"

git clone git@github.com:keziah55/cycleTracks.git

# make venv in cycleTracksTest, not cycleTracks, because pytest was picking up
# conftest.py files from modules installed in the venv (e.g. numpy)
python3 -m venv .

cd cycleTracks
echo "cd cycleTracks"

../bin/python -m pip -V

../bin/python -m pip install -r requirements.txt --no-cache-dir --no-warn-script-location
../bin/python -m pip install pytest pytest-qt pytest-cov pytest-profiling --no-cache-dir --no-warn-script-location

resultsDir="results"
mkdir "$resultsDir"

# test with pyside2, then pyqt5
for qt_api in pyside2 pyqt5; do
    export QT_API=$qt_api
    export PYTEST_QT_API=$qt_api
    echo "QT_API: $QT_API"
    echo "PYTEST_QT_API: $PYTEST_QT_API"
    ../bin/python -m pytest -v --cov=cycleTracks --cov-report term-missing --profile-svg --junitxml="./$resultsDir/$qt_api-results.xml"
    mv prof "$resultsDir/$qt_api-prof"
done

mv "$resultsDir" "$origDir"